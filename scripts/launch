#!/bin/sh
# Launch an arbitrary command in a working pfs environment.
###############################################################################

set -Ee          # pass trap handlers down to subshells, exit on error

DIR="$(cd "$(dirname "${0}")" && pwd)"
cd "${DIR}"

. "${DIR}/lib/lib.sh"

CONTAINER_COMMAND=$@
if [ -z "${CONTAINER_COMMAND}" ]; then
    CONTAINER_COMMAND="/go/bin/shard 0-1 localhost" #default command
fi

check_value_set AWS_ACCESS_KEY_ID
check_value_set AWS_SECRET_ACCESS_KEY
check_btrfs
check_docker

log_command "${DIR}/clean"

log_command mkdir -p "${PFS_HOST_VOLUME}"
log_command truncate "${PFS_DATA_IMG}" -s 10G
log_command mkfs.btrfs "${PFS_DATA_IMG}"
log_command sudo mount "${PFS_DATA_IMG}" "${PFS_HOST_VOLUME}"
log_command mkdir -p /var/lib/pfs/vol

DAEMONIZE="-d"
if [ -z "${PFS_DAEMONIZE}" ]; then
  DAEMONIZE=
fi

log_command sudo docker run \
    ${DAEMONIZE} \
    --privileged=true \
    --name "${PFS_CONTAINER_NAME}" \
    -v /:/host:ro \
    -v "${PFS_HOST_VOLUME}:/host/var/lib/pfs/vol" \
    -v "${PFS_DIR}:/var/lib/pfs" \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}" \
    -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}" \
    -e GOMAXPROCS="${GOMAXPROCS}" \
    -e PFS_HOST_VOLUME="${PFS_HOST_VOLUME}" \
    -p "${PFS_PORT}":80 \
    -i "${PFS_IMAGE}" \
    ${CONTAINER_COMMAND}

echo "Server is listening on localhost:${PFS_PORT}"
echo "Logging to ${PFS_DIR}/log/log-0-1"
echo "Data is stored in ${PFS_HOST_VOLUME}"
echo "To kill:"
echo "docker kill ${PFS_CONTAINER_NAME}"
