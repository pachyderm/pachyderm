version: 2.1

orbs:
    codecov: codecov/codecov@1.1.0
    pagerduty: fredbi/pagerduty@0.3.0

jobs:
    backend-test:
        docker:
            - image: circleci/node:14.16.0
        steps:
            - checkout
            - run: cd frontend && npm ci
            - run: cd backend && npm ci
            - run: cd backend && npm run lint
            - run: cd backend && npm run test -- --collect-coverage
            - codecov/upload:
                  file: backend/coverage/lcov.info
    frontend-test:
        resource_class: xlarge
        docker:
            - image: circleci/node:14.16.0
        steps:
            - checkout
            - run: cd backend && npm ci
            - run: cd frontend && npm ci
            - run: cd frontend && npm run lint
            - run: cd frontend && npm run test -- --collect-coverage
            - codecov/upload:
                  file: frontend/coverage/lcov.info
    build:
        resource_class: xlarge
        docker:
            - image: circleci/node:14.16.0
        steps:
            - checkout
            - run: make ci
            - run: make build
    live-automation:
        resource_class: xlarge
        docker:
            - image: circleci/node:14.14.0-browsers
        steps:
            - checkout
            - run: cd live-automation && npm install
            - run:
                  cd live-automation &&
                  CYPRESS_RECORD_KEY=$LIVE_AUTOMATION_RECORD_KEY npm run
                  test-and-report-production
            - store_artifacts:
                  path: /tmp/cypress-screenshots
            - store_artifacts:
                  path: /tmp/cypress-videos
            - store_artifacts:
                  path: /tmp/cypress-network
            - pagerduty/notify:
                  when: on_fail
                  severity: critical
                  component: production
                  incident_title:
                      "Dash Live automation run against production failed"

workflows:
    version: 2
    test:
        jobs:
            - backend-test
            - frontend-test
            - build
    live-automation:
        triggers:
            - schedule:
                  cron: "10,30,50 * * * *"
                  filters:
                      branches:
                          only: master
        jobs:
            - live-automation
