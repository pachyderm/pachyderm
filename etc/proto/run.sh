#!/bin/bash
set -ex

tar -C "${GOPATH}/src/github.com/pachyderm/pachyderm" -xf /dev/stdin

# Make sure the proto compiler is reasonably up-to-date so that our compiled
# protobufs aren't generated by stale tools
max_age="$(date --date="1 month ago" +%s)"
if [[ "${max_age}" -gt "$(cat /last_run_time)" ]]; then
    PRE="\e[1;31m~\e[0m"
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    echo -e "${PRE} \e[1;31mWARNING:\e[0m pachyderm_proto is out of date" >/dev/stderr
    echo -e "${PRE} please run" >/dev/stderr
    echo -e "${PRE}   make DOCKER_BUILD_FLAGS=--no-cache proto" >/dev/stderr
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    exit 1
fi

cd "${GOPATH}/src/github.com/pachyderm/pachyderm"
mkdir -p v2/src
mkdir -p v2/src/internal/jsonschema

# shellcheck disable=SC2044
for i in $(find src -name "*.proto"); do \
    if ! grep -q 'go_package' "${i}"; then
        echo -e "\e[1;31mError:\e[0m missing \"go_package\" declaration in ${i}" >/dev/stderr
    fi
    protoc \
        -Isrc \
        --plugin=protoc-gen-zap="${GOPATH}/bin/protoc-gen-zap" \
        --plugin="${GOPATH}/bin/protoc-gen-jsonschema" \
        --zap_out=":${GOPATH}/src" \
        --go_out=":${GOPATH}/src" \
        --go-grpc_out=":${GOPATH}/src" \
        --jsonschema_opt="enforce_oneof" \
        --jsonschema_opt="file_extension=schema.json" \
        --jsonschema_opt="disallow_additional_properties" \
        --jsonschema_opt="enums_as_strings_only" \
        --jsonschema_opt="disallow_bigints_as_strings" \
        --jsonschema_out="${GOPATH}/src/github.com/pachyderm/pachyderm/v2/src/internal/jsonschema" \
    "${i}" >/dev/stderr
done

pushd src > /dev/stderr
read -ra proto_files < <(find . -name "*.proto" -print0 | xargs -0)
protoc \
    --proto_path . \
    --plugin=protoc-gen-pach="${GOPATH}/bin/protoc-gen-pach" \
    --pach_out="../v2/src" \
    "${proto_files[@]}" > /dev/stderr

popd > /dev/stderr

pushd v2 > /dev/stderr
pushd src > /dev/stderr
gopatch ./... -p=/proto.patch
popd > /dev/stderr

gofmt -w . > /dev/stderr
find . -regextype egrep -regex ".*[.](go|schema.json)$" -print0 | xargs -0 tar cf -
