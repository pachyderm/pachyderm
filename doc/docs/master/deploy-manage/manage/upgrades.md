# Upgrade Pachyderm

Upgrades between minor releases or point releases, such as `2.1.0` to version `2.2.0`,
do not introduce breaking changes. 
Therefore, the upgrade procedure is simple and requires little to no downtime.

!!! Warning 
       Do not use these steps to upgrade between major versions as it might result in data corruption.

Complete the following steps to upgrade Pachyderm from one minor release to another.
## Backup your cluster

As a general good practice, start with the backup of your cluster as described in the [Backup and Restore](../backup_restore/#backup-your-cluster)
section of this documentation.

## Update your helm values

Some values are automatically generated during the installation. 
**If you do not include these back into the values file you used when you deployed the previous Pachyderm version or save them in secret, the upgrade will likely fail**.

The settings that are autogenerated if they are blank during installation are:

```yaml 
global:
      postgresql.postgresqlPassword
pachd:
      clusterDeploymentID
      rootToken
      enterpriseSecret
      oauthClientSecret
```

**You must add the secret to your values file** or supply them via `--set` on the command line during the upgrade. Check the [troubleshooting section](#troubleshoot-point-release-upgrades) at the end of this page for information on how to retrieve those values.

!!! Warning "CARRY OVER YOUR CLUSTERID"

       Aside from retrieving any auto generated values and inserting them back as credentials in your values.yaml or as secrets, you will need to **retrieve your clusterID in your`~/.pachyderm/config.json` or by running `pachctl config get context <your-config-name>' (run `pachctl list context` to list out all contexts) and carry it over to your new deployment by setting the field `pachd.clusterDeploymentID`** with your existing clusterID.  

## Upgrade `pachctl` version
 
 - To update to the latest version of Pachyderm, run the steps below depending on your operating system:
  
      * For macOS, run:  
  
      ```shell  
      brew tap pachyderm/tap && brew install pachyderm/tap/pachctl@{{ config.pach_major_minor_version }}  
      ```  
  
      * For a Debian-based Linux 64-bit or Windows 10 or later running on  
      WSL:  
  
      ```shell  
      curl -o /tmp/pachctl.deb -L https://github.com/pachyderm/pachyderm/releases/download/v{{ config.pach_latest_version }}/pachctl_{{ config.pach_latest_version }}_amd64.deb && sudo dpkg -i /tmp/pachctl.deb  
      ```  
  
      * For all other Linux flavors:  
  
      ```shell  
      curl -o /tmp/pachctl.tar.gz -L https://github.com/pachyderm/pachyderm/releases/download/v{{ config.pach_latest_version }}/pachctl_{{ config.pach_latest_version }}_linux_amd64.tar.gz && tar -xvf /tmp/pachctl.tar.gz -C /tmp && sudo cp /tmp/pachctl_{{ config.pach_latest_version }}_linux_amd64/pachctl /usr/local/bin  
      ```  

!!! Note
      For a specific target release, specify the targeted major/minor version of `pachctl` for brew and major/minor/point release for curl in the commands above.


 - Verify that the installation was successful by running `pachctl version --client-only`:  
  
      ```shell  
      pachctl version --client-only  
      ```  
  
      **System Response:**  
  
      ```shell  
      COMPONENT           VERSION  
      pachctl             <This should display the version you installed>  
      ```  

## Helm upgrade

- Redeploy Pachyderm by running the [helm upgrade](https://helm.sh/docs/helm/helm_upgrade/){target=_blank} command with your updated values.yaml:

      ```shell
      helm upgrade pachd -f my_pachyderm_values.yaml pach/pachyderm
      ```

      **System response:**

      ```shell
      Release "pachd" has been upgraded. Happy Helming!
      NAME: pachd
      LAST DEPLOYED: Wed Jan 22 13:37:45 2022
      NAMESPACE: default
      STATUS: deployed
      REVISION: 2
      ```

- The upgrade can take some time. You can run `kubectl get pods` periodically
to check the status of the deployment. When Pachyderm is deployed, the command
shows all pods as `READY`:

      ```shell
      kubectl get pods
      ```
      Once the pods are up, you should see a pod for `pachd` running 
      (alongside etcd, pg-bouncer, postgres, console etc... depending on your installation). 

      **System response:**

      ```shell
      NAME                     READY     STATUS    RESTARTS   AGE
      pachd-3677268306-9sqm0   1/1       Running   0          4m
      ...
      ```

- Verify that the new version has been deployed:

      ```shell
      pachctl version
      ```

      **System response:**

      ```shell
      COMPONENT           VERSION
      pachctl             {{ config.pach_latest_version }}
      pachd               {{ config.pach_latest_version }}
      ```

      The `pachd` and `pachctl` versions must both match the new version.

## Troubleshoot point release upgrades

Most of the issues you might run into when
upgrading Pachyderm is related to the failure to retrieve 
then re-set default values that were generated during the first installation.

Here is a list of all the values used by Pachyderm when installing/upgrading a cluster. Some are optional and dependent on your installation choices.

In general, these values can be provided in three different ways:

- **A - (RECOMMENDED in production) Create your secret(s) ahead of your cluster creation** 
      
      **Create your secret(s) ahead of your cluster creation** and provide each secret name in your values.yaml at the time of the first installation. 

      Find the list of Secret Keys for each setting and their corresponding secret name field in your values.yaml (Column A) in the table below.

- **B - Provide credentials directly in your values.yaml**

      You do not want to create your secrets right away, but provide specific secret credentials directly in your values.yaml or by setting them  with a `--set` argument during the upgrade.

      In this case, (see column B), we will read then insert those values in a default secret `pachyderm-bootstrap-config` for you. The associated keys in `pachyderm-bootstrap-config` are listed in column C of the following table.


- **C - Neither A nor B**

      You have not created secrets ahead of your installation, nor did you provide values directly in the values.yaml; we created default values for you in the default secret `pachyderm-bootstrap-config` (See column C below for their key).
      
      Example: Use `kubectl get secret pachyderm-bootstrap-config -o go-template='{{.data.rootToken | base64decode }}'` to retrieve your rootToken.

!!! Important
       It is important to note that if no secret name is provided for the fields mentioned in **A**, Pachyderm will retrieve the dedicated plain-text secret values in the helm values (**B**) and populate a generic, default, auto-generated secret (pachyderm-bootstrap-config) at the time of the installation (**C**). If no value is found in either one of those two cases, default values are used in `pachyderm-bootstrap-config`.

|KEY name in a Secret| Description | A - Create your secrets ahead <br> of your cluster creation| B - Pass credentials in values.yaml| C - Neither A nor B - See default `pachyderm-bootstrap-config` keys| 
|------------|------------|-----|--------|---------|
|root_token| Root clusterAdmin| pachd.rootTokenSecretName |pachd.rootToken|rootToken|
|root_token|Root clusterAdmin of the enterprise server|pachd.enterpriseRootTokenSecretName|pachd.enterpriseRootToken|enterpriseRootToken|
|postgresql_password|Password to your database|global.postgresql.postgresqlExistingSecretName <br> global.postgresql.postgresqlExistingSecretKey |global.postgresql.postgresqlPassword|postgresql-password * in separate secret|
|OAUTH_CLIENT_SECRET|Oauth client secret for Console <br> Required if you set Console|console.config.oauthClientSecretSecretName |console.config.oauthClientSecret|oidcClients[1].secret|
|enterprise_license_key|Your enterprise license|pachd.enterpriseLicenseKeySecretName |pachd.enterpriseLicenseKey|license|
|pachd_oauth_client_secret| Oauth client secret for pachd| pachd.oauthClientSecretSecretName|pachd.oauthClientSecret|oidcClients[0].secret|
|enterprise_secret|Needed if you connect to an enterprise server|pachd.enterpriseSecretSecretName  |pachd.enterpriseSecret|enterpriseSecret|
|upstream_idps|The list of dex connectors, each containing Oauth client info connecting to an upstream IDP|oidc.upstreamIDPsSecretName|oidc.upstreamIDPs|idps|

!!! Warning "Attention users of Pachyderm bundled PostgreSQL"
      If you are using the **built in postgreSQL, you cannot use an existing secret to pass postgreSQL credentials**. You need to retrieve then pass your auto-generated credentials in your values (`global.postgresql.postgresqlPassword`).
