dist: ../dist-pach/docker

builds:
  -
    id: pachd
    dir: src/server/cmd/pachd
    main: main.go
    binary: pachd
    env:
      - CGO_ENABLED=0
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: worker
    dir: src/server/cmd/worker
    main: main.go
    binary: worker
    env:
      - CGO_ENABLED=0
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: worker_init
    dir: etc/worker
    main: init.go
    binary: worker_init
    env:
      - CGO_ENABLED=0
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: pachctl
    dir: src/server/cmd/pachctl
    main: main.go
    binary: pachctl
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
      - darwin
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: mount-server
    dir: src/server/cmd/mount-server
    main: main.go
    binary: mount-server
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
      - darwin
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: pachtf
    dir: src/server/cmd/pachtf
    main: main.go
    binary: pachtf
    env:
      - CGO_ENABLED=0
    ldflags:
      - -X {{ .Env.CLIENT_ADDITIONAL_VERSION }} -X "github.com/pachyderm/pachyderm/v2/src/version.AppVersion={{ .Env.VERSION }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"

archives:
  - format: binary
    builds:
      - pachctl

checksum:
  disable: true

changelog:
  skip: true

release:
  disable: true

dockers:
  -
    image_templates:
      - pachyderm/pachd
      - pachyderm/pachd:local
      - "pachyderm/pachd:{{.Version}}"
    ids:
      - pachd
    goos: linux
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachd
    extra_files:
      - dex-assets
      - LICENSE
      - licenses
    build_flag_templates:
      - "--network=host"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
  -
    image_templates:
      - pachyderm/pachctl
    ids:
      - pachctl
    goos: linux
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachctl
    build_flag_templates:
      - "--network=host"
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/mount-server
    ids:
      - mount-server
    goos: linux
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.mount-server
    build_flag_templates:
      - "--network=host"
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/worker
      - pachyderm/worker:local
    ids:
      - pachctl
      - worker_init
      - worker
      - pachtf
    goos: linux
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.worker
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
    extra_files:
      - LICENSE
      - licenses
